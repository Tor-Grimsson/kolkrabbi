{"version":3,"file":"index.js","names":[],"sources":["../../src/draft-mode/define-enable-draft-mode.ts"],"sourcesContent":["import type {SanityClient} from '@sanity/client'\nimport {validatePreviewUrl} from '@sanity/preview-url-secret'\nimport {perspectiveCookieName} from '@sanity/preview-url-secret/constants'\nimport {cookies, draftMode} from 'next/headers'\nimport {redirect} from 'next/navigation'\n\n/**\n * @public\n */\nexport interface DefineEnableDraftModeOptions {\n  client: SanityClient\n  /**\n   * Force secure cookies in development mode.\n   * Enable this when using Next.js --experimental-https flag.\n   * This option has no effect in production (cookies are always secure).\n   * @defaultValue false\n   */\n  secureDevMode?: boolean\n}\n\n/**\n * @public\n */\nexport interface EnableDraftMode {\n  GET: (request: Request) => Promise<Response>\n}\n\n/**\n * Sets up an API route for enabling draft mode, can be paired with the `previewUrl.previewMode.enable` in `sanity/presentation`.\n * Can also be used with `sanity-plugin-iframe-pane`.\n * @example\n * ```ts\n * // src/app/api/draft-mode/enable/route.ts\n *\n * import { defineEnableDraftMode } from \"next-sanity/draft-mode\";\n * import { client } from \"@/sanity/lib/client\";\n *\n * export const { GET } = defineEnableDraftMode({\n *   client: client.withConfig({ token: process.env.SANITY_API_READ_TOKEN }),\n * });\n * ```\n *\n * @public\n */\nexport function defineEnableDraftMode(options: DefineEnableDraftModeOptions): EnableDraftMode {\n  const {client} = options\n  return {\n    GET: async (request: Request) => {\n      // eslint-disable-next-line no-warning-comments\n      // @TODO check if already in draft mode at a much earlier stage, and skip validation\n\n      const {\n        isValid,\n        redirectTo = '/',\n        studioPreviewPerspective,\n      } = await validatePreviewUrl(client, request.url)\n      if (!isValid) {\n        return new Response('Invalid secret', {status: 401})\n      }\n\n      const draftModeStore = await draftMode()\n\n      // Let's enable draft mode if it's not already enabled\n      if (!draftModeStore.isEnabled) {\n        draftModeStore.enable()\n      }\n\n      const isProduction = process.env.NODE_ENV === 'production'\n\n      // We can't auto-detect HTTPS in dev due to Next.js limitations,\n      // so we need an explicit option\n      const isSecure = isProduction || (options.secureDevMode ?? false)\n\n      // Override cookie header for draft mode for usage in live-preview\n      // https://github.com/vercel/next.js/issues/49927\n      const cookieStore = await cookies()\n      const cookie = cookieStore.get('__prerender_bypass')!\n      cookieStore.set({\n        name: '__prerender_bypass',\n        value: cookie?.value,\n        httpOnly: true,\n        path: '/',\n        secure: isSecure,\n        sameSite: isSecure ? 'none' : 'lax',\n      })\n\n      if (studioPreviewPerspective) {\n        cookieStore.set({\n          name: perspectiveCookieName,\n          value: studioPreviewPerspective,\n          httpOnly: true,\n          path: '/',\n          secure: isSecure,\n          sameSite: isSecure ? 'none' : 'lax',\n        })\n      }\n\n      // the `redirect` function throws, and eventually returns a Promise<Response>. TSC doesn't \"see\" that so we have to tell it\n      return redirect(redirectTo) as Promise<Response>\n    },\n  }\n}\n"],"mappings":";;;;AA4CA,SAAgB,sBAAsB,SAAwD;CAC5F,MAAM,EAAC,WAAU;AACjB,QAAO,EACL,KAAK,OAAO,YAAqB;EAI/B,MAAM,EACJ,SACA,aAAa,KACb,6BACE,MAAM,mBAAmB,QAAQ,QAAQ,IAAI;AACjD,MAAI,CAAC,QACH,QAAO,IAAI,SAAS,kBAAkB,EAAC,QAAQ,KAAI,CAAC;EAGtD,MAAM,iBAAiB,MAAM,WAAW;AAGxC,MAAI,CAAC,eAAe,UAClB,gBAAe,QAAQ;EAOzB,MAAM,WAJe,QAAQ,IAAI,aAAa,iBAIZ,QAAQ,iBAAiB;EAI3D,MAAM,cAAc,MAAM,SAAS;EACnC,MAAM,SAAS,YAAY,IAAI,qBAAqB;AACpD,cAAY,IAAI;GACd,MAAM;GACN,OAAO,QAAQ;GACf,UAAU;GACV,MAAM;GACN,QAAQ;GACR,UAAU,WAAW,SAAS;GAC/B,CAAC;AAEF,MAAI,yBACF,aAAY,IAAI;GACd,MAAM;GACN,OAAO;GACP,UAAU;GACV,MAAM;GACN,QAAQ;GACR,UAAU,WAAW,SAAS;GAC/B,CAAC;AAIJ,SAAO,SAAS,WAAW;IAE9B"}